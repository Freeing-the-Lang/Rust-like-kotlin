name: "SpongeLang — FULL AUTO Build + META + Release"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ============================================================
  # AUTO TAG
  # ============================================================
  auto-tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate Tag
        id: tag
        run: |
          TAG="v$(date +'%Y%m%d%H%M%S')"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Push Tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag ${{ steps.tag.outputs.tag }}
          git push origin ${{ steps.tag.outputs.tag }}

  # ============================================================
  # BUILD (Linux / macOS / Windows)
  # ============================================================
  build:
    needs: auto-tag
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      # Rust setup
      - uses: dtolnay/rust-toolchain@stable

      # NASM installs
      - name: Install NASM (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y nasm

      - name: Install NASM (macOS)
        if: matrix.os == 'macos-latest'
        run: brew install nasm

      - name: Install NASM (Windows)
        if: matrix.os == 'windows-latest'
        run: choco install nasm -y

      # Build compiler
      - name: Build rlkc
        run: cargo build --release

      - name: Prepare folders
        run: mkdir -p build/meta build/bin

      # ==================================================================
      # COMPILE SpongeLang → ASM
      # ==================================================================
      - name: Compile SpongeLang Input
        shell: bash
        run: |
          ./target/release/rlkc > build/out.asm

      # ==================================================================
      # Assemble & Link
      # ==================================================================
      - name: Build Executable (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          nasm -felf64 build/out.asm -o build/out.o
          ld build/out.o -o build/bin/spongelang

      - name: Build Executable (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          nasm -fmacho64 build/out.asm -o build/out.o
          ld build/out.o -o build/bin/spongelang

      - name: Build Executable (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          nasm -fwin64 build/out.asm -o build/out.obj
          link.exe build/out.obj /SUBSYSTEM:CONSOLE /OUT:build\bin\spongelang.exe

      # ==================================================================
      # META PACK AUTO GEN
      # ==================================================================
      - name: Generate META Pack
        shell: bash
        run: |
          OS="${{ matrix.os }}"
          TS=$(date +'%Y-%m-%d %H:%M:%S')
          SHA=$(git rev-parse HEAD)

          echo "os: $OS" > build/meta/meta.yml
          echo "timestamp: $TS" >> build/meta/meta.yml
          echo "commit: $SHA" >> build/meta/meta.yml
          echo "compiler: rlkc (SpongeLang Static Type Compiler)" >> build/meta/meta.yml

          # sha256
          if [[ "$OS" == "windows-latest" ]]; then
            CERTUTIL_OUTPUT=$(certutil -hashfile build/bin/spongelang.exe SHA256 | findstr /v "hash")
            echo "sha256: $CERTUTIL_OUTPUT" >> build/meta/meta.yml
          else
            SHA=$(sha256sum build/bin/spongelang | awk '{print $1}' || sha256sum build/bin/spongelang.exe | awk '{print $1}')
            echo "sha256: $SHA" >> build/meta/meta.yml
          fi

          # input.sp info
          echo "input_size: $(wc -c < input.sp)" >> build/meta/meta.yml

      # ==================================================================
      # PACKAGE
      # ==================================================================
      - name: Create ZIP
        shell: bash
        run: |
          ZIPNAME="spongelang-${{ matrix.os }}.zip"
          cd build
          zip -r "../${ZIPNAME}" bin meta

      # Upload
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: spongelang-${{ matrix.os }}
          path: spongelang-${{ matrix.os }}.zip


  # ============================================================
  # RELEASE
  # ============================================================
  release:
    needs: [auto-tag, build]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: release-files

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.auto-tag.outputs.tag }}
          name: "SpongeLang META Release — ${{ needs.auto-tag.outputs.tag }}"
          body: |
            SpongeLang Full Auto META Release  
            - 3 OS binaries  
            - META Pack  
            - Static Type SpongeLang Compiler  
            - Input + ASM + EXE  
          files: release-files/**/*.zip
