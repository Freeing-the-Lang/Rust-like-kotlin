name: RLK → SpongeLang → NASM Full Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

env:
  APP_VERSION: "v1.0.0"
  RLK_BIN: rlkc
  SPONGE_BIN: sponge
  BUILD_DIR: build
  PROOF_DIR: proof

permissions:
  contents: write

jobs:
  build-3os:
    name: Build RLK Pipeline (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      # ---------------------------------------------------------
      # 1. Checkout
      # ---------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # 2. Install Rust
      # ---------------------------------------------------------
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      # ---------------------------------------------------------
      # 3. Build RLK Compiler (Rust-like-Kotlin → SpongeLang)
      # ---------------------------------------------------------
      - name: Build RLK Compiler
        run: cargo build --release

      # ---------------------------------------------------------
      # 4. Download SpongeLang Released VM
      # ---------------------------------------------------------
      - name: Download SpongeLang VM
        run: |
          echo "Downloading SpongeLang existing release..."
          curl -L https://github.com/Freeing-the-Lang/Sponge-lang/releases/latest/download/spongevm -o spongevm
          chmod +x spongevm

      # ---------------------------------------------------------
      # 5. Prepare directories
      # ---------------------------------------------------------
      - name: Prepare build directories
        run: |
          mkdir -p $BUILD_DIR
          mkdir -p $PROOF_DIR

      # ---------------------------------------------------------
      # 6. Transpile RLK → SpongeLang (.sp)
      # ---------------------------------------------------------
      - name: Run RLK compiler
        run: |
          ./target/release/${RLK_BIN} examples/hello.rlk > $BUILD_DIR/output.sp

      # ---------------------------------------------------------
      # 7. Run SpongeLang VM → NASM
      # ---------------------------------------------------------
      - name: SpongeLang → NASM
        run: |
          ./spongevm --emit-nasm $BUILD_DIR/output.sp -o $BUILD_DIR/out.asm

      # ---------------------------------------------------------
      # 8. Assemble NASM → Binary
      # ---------------------------------------------------------
      - name: Install NASM
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y nasm

      - name: Build binary
        if: matrix.os == 'ubuntu-latest'
        run: |
          nasm -f elf64 $BUILD_DIR/out.asm -o $BUILD_DIR/out.o
          gcc $BUILD_DIR/out.o -o $BUILD_DIR/out.bin

      # ---------------------------------------------------------
      # 9. SHA256 Proof generation
      # ---------------------------------------------------------
      - name: Generate SHA256 Proof
        run: |
          sha256sum $BUILD_DIR/* > $PROOF_DIR/sha256_proof_${{ matrix.os }}.txt

      # ---------------------------------------------------------
      # 10. ProofLedger
      # ---------------------------------------------------------
      - name: Generate ProofLedger
        run: |
          echo "Build OS: ${{ matrix.os }}" > $PROOF_DIR/proofledger_${{ matrix.os }}.txt
          echo "Version: $APP_VERSION" >> $PROOF_DIR/proofledger_${{ matrix.os }}.txt
          echo "Timestamp: $(date)" >> $PROOF_DIR/proofledger_${{ matrix.os }}.txt
          echo "Commit: $GITHUB_SHA" >> $PROOF_DIR/proofledger_${{ matrix.os }}.txt

      # ---------------------------------------------------------
      # 11. Upload artifacts (per OS)
      # ---------------------------------------------------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: RLK-Pipeline-${{ matrix.os }}
          path: |
            build/
            proof/
            $BUILD_DIR/output.sp
            $BUILD_DIR/out.asm
            $BUILD_DIR/out.bin
            $PROOF_DIR/*.txt

  # -----------------------------------------------------------
  # 12. Release job (after all builds)
  # -----------------------------------------------------------
  release:
    name: Publish Release
    needs: [ build-3os ]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.APP_VERSION }}
          name: "RLK Full Pipeline ${{ env.APP_VERSION }}"
          draft: false
          prerelease: false
          files: |
            **/*.bin
            **/*.sp
            **/*.asm
            **/*.txt
