name: RLK → SpongeLang → NASM Full Auto Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

env:
  BUILD_DIR: build
  PROOF_DIR: proof

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
    # ------------------------------------------------------------
    # Checkout
    # ------------------------------------------------------------
    - uses: actions/checkout@v4

    # ------------------------------------------------------------
    # Install Rust
    # ------------------------------------------------------------
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    # ------------------------------------------------------------
    # Build RLK Compiler
    # ------------------------------------------------------------
    - name: Build RLK Compiler
      shell: bash
      run: cargo build --release

    # ------------------------------------------------------------
    # Detect RLK Compiler Binary
    # ------------------------------------------------------------
    - name: Detect RLK Binary
      shell: bash
      run: |
        echo "Searching for RLK compiler..."
        ls -R ./target/release

        CANDIDATE=$(find ./target/release -maxdepth 1 -type f \( -name "rlkc" -o -name "rlkc.exe" -o -name "rust-like-kotlin" -o -name "rust-like-kotlin.exe" \) | head -n 1)

        if [ -z "$CANDIDATE" ]; then
            echo "ERROR: RLK compiler not found!"
            exit 1
        fi

        echo "RLK_PATH=$CANDIDATE" >> $GITHUB_ENV
        echo "Detected RLK: $CANDIDATE"

    # ------------------------------------------------------------
    # Download SpongeLang VM (Auto detect)
    # ------------------------------------------------------------
    - name: Download SpongeLang VM (Auto-detect)
      shell: bash
      run: |
        mkdir -p sponge

        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            ZIP_URL="https://github.com/Freeing-the-Lang/Sponge-lang/releases/latest/download/linux.zip"
        elif [ "${{ matrix.os }}" = "macos-latest" ]; then
            ZIP_URL="https://github.com/Freeing-the-Lang/Sponge-lang/releases/latest/download/macos.zip"
        else
            ZIP_URL="https://github.com/Freeing-the-Lang/Sponge-lang/releases/latest/download/windows.zip"
        fi

        echo "Downloading VM: $ZIP_URL"
        curl -L -o sponge/vm.zip "$ZIP_URL"
        unzip sponge/vm.zip -d sponge/

        echo "Searching for executable..."
        FOUND=$(find sponge -type f \( -perm -111 -o -name "*.exe" \) | head -n 1)

        if [ -z "$FOUND" ]; then
            echo "ERROR: VM binary not found!"
            find sponge -type f
            exit 1
        fi

        echo "Detected VM: $FOUND"

        if [[ "$FOUND" == *.exe ]]; then
            mv "$FOUND" ./spongevm.exe
            chmod +x ./spongevm.exe
        else
            mv "$FOUND" ./spongevm
            chmod +x ./spongevm
        fi

    # ------------------------------------------------------------
    # Prepare directories
    # ------------------------------------------------------------
    - name: Prepare Directories
      shell: bash
      run: |
        mkdir -p $BUILD_DIR
        mkdir -p $PROOF_DIR

    # ------------------------------------------------------------
    # Ensure example RLK
    # ------------------------------------------------------------
    - name: Ensure example RLK exists
      shell: bash
      run: |
        if [ ! -f examples/hello.rlk ]; then
            mkdir -p examples
            echo "let x = 10;" > examples/hello.rlk
            echo "print(x);" >> examples/hello.rlk
        fi

    # ------------------------------------------------------------
    # RLK → SpongeLang (.sp)
    # ------------------------------------------------------------
    - name: RLK → SpongeLang
      shell: bash
      run: |
        $RLK_PATH examples/hello.rlk > $BUILD_DIR/output.sp
        cat $BUILD_DIR/output.sp

    # ------------------------------------------------------------
    # SpongeLang → NASM
    # ------------------------------------------------------------
    - name: SpongeLang → NASM
      shell: bash
      run: |
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
            ./spongevm.exe --emit-nasm $BUILD_DIR/output.sp -o $BUILD_DIR/output.asm
        else
            ./spongevm --emit-nasm $BUILD_DIR/output.sp -o $BUILD_DIR/output.asm
        fi
        cat $BUILD_DIR/output.asm

    # ------------------------------------------------------------
    # Linux only → NASM → Binary
    # ------------------------------------------------------------
    - name: Install NASM (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y nasm gcc

    - name: Build Binary (Linux)
      if: runner.os == 'Linux'
      run: |
        nasm -f elf64 $BUILD_DIR/output.asm -o $BUILD_DIR/output.o
        gcc $BUILD_DIR/output.o -o $BUILD_DIR/output.bin
        echo "Built: $BUILD_DIR/output.bin"

    # ------------------------------------------------------------
    # SHA256 Proof
    # ------------------------------------------------------------
    - name: Generate SHA256 Proof
      shell: bash
      run: |
        if command -v sha256sum ; then
            sha256sum $BUILD_DIR/* > $PROOF_DIR/sha256_${{ matrix.os }}.txt
        else
            shasum -a 256 $BUILD_DIR/* > $PROOF_DIR/sha256_${{ matrix.os }}.txt
        fi

    # ------------------------------------------------------------
    # ProofLedger
    # ------------------------------------------------------------
    - name: Generate ProofLedger
      shell: bash
      run: |
        echo "OS: ${{ matrix.os }}" > $PROOF_DIR/proofledger_${{ matrix.os }}.txt
        echo "Timestamp: $(date)" >> $PROOF_DIR/proofledger_${{ matrix.os }}.txt
        echo "Commit: $GITHUB_SHA" >> $PROOF_DIR/proofledger_${{ matrix.os }}.txt

    # ------------------------------------------------------------
    # Upload Artifacts
    # ------------------------------------------------------------
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: RLK-Pipeline-${{ matrix.os }}
        path: |
          build/
          proof/
          spongevm*
          $BUILD_DIR/*
          $PROOF_DIR/*


# =============================================================
# RELEASE JOB
# =============================================================
  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - uses: actions/download-artifact@v4

    - name: Publish Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v1.${{ github.run_number }}
        name: "RLK Full Auto Pipeline v1.${{ github.run_number }}"
        files: |
          RLK-Pipeline-ubuntu-latest/**
          RLK-Pipeline-macos-latest/**
          RLK-Pipeline-windows-latest/**
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
