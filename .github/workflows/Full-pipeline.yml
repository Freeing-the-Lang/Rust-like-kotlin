name: RLK → SpongeLang → NASM Full Auto Pipeline (Absolute Stable Edition)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

env:
  BUILD_DIR: build
  PROOF_DIR: proof

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
    # ------------------------------------------------------------
    # Checkout
    # ------------------------------------------------------------
    - uses: actions/checkout@v4

    # ------------------------------------------------------------
    # Install Rust
    # ------------------------------------------------------------
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    # ------------------------------------------------------------
    # Build RLK Compiler
    # ------------------------------------------------------------
    - name: Build RLK Compiler
      shell: bash
      run: cargo build --release

    # ------------------------------------------------------------
    # Detect RLK Compiler Binary
    # ------------------------------------------------------------
    - name: Detect RLK Binary
      shell: bash
      run: |
        CANDIDATE=$(find ./target/release -maxdepth 1 -type f \
          \( -name "rlkc" -o -name "rlkc.exe" -o -name "rust-like-kotlin" -o -name "rust-like-kotlin.exe" \) \
          | head -n 1)

        if [ -z "$CANDIDATE" ]; then
            echo "ERROR: RLK compiler not found!"
            exit 1
        fi

        echo "RLK_PATH=$CANDIDATE" >> $GITHUB_ENV
        echo "Detected RLK compiler: $CANDIDATE"

    # ------------------------------------------------------------
    # Download SpongeLang VM (auto detect + auto meta fix)
    # ------------------------------------------------------------
    - name: Download SpongeLang VM (Ultimate Auto-Detect + META Fix)
      shell: bash
      run: |
        mkdir -p sponge

        # Select correct ZIP by OS
        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            ZIP_URL="https://github.com/Freeing-the-Lang/Sponge-lang/releases/latest/download/linux.zip"
        elif [ "${{ matrix.os }}" = "macos-latest" ]; then
            ZIP_URL="https://github.com/Freeing-the-Lang/Sponge-lang/releases/latest/download/macos.zip"
        else
            ZIP_URL="https://github.com/Freeing-the-Lang/Sponge-lang/releases/latest/download/windows.zip"
        fi

        curl -L -o sponge/vm.zip "$ZIP_URL"
        unzip sponge/vm.zip -d sponge/

        # --- Auto detect executable ---
        CANDIDATES=$(find sponge -type f \
          ! -name "*.hpp" ! -name "*.cpp" ! -name "*.txt" \
          ! -name "*.md" ! -name "CMakeLists.txt")

        FOUND=""
        for FILE in $CANDIDATES; do
            INFO=$(file "$FILE")
            if echo "$INFO" | grep -qE "ELF|Mach-O|PE32"; then
                FOUND="$FILE"
                break
            fi
        done

        if [ -z "$FOUND" ]; then
            FOUND=$(echo "$CANDIDATES" | grep -Ei "sponge|vm|runner|main" | head -n 1)
        fi

        if [ -z "$FOUND" ]; then
            echo "ERROR: No VM binary detected!"
            exit 1
        fi

        # --- Move binary to root ---
        if [[ "$FOUND" == *.exe ]]; then
            mv "$FOUND" ./spongevm.exe
            chmod +x ./spongevm.exe
        else
            mv "$FOUND" ./spongevm
            chmod +x ./spongevm
        fi

        # --- Auto detect META folder wherever it is ---
        META_FILE=$(find sponge -type f -name "*.meta" -print -quit)
        if [ -z "$META_FILE" ]; then
            echo "ERROR: No .meta files found in ZIP!"
            exit 1
        fi
        META_DIR=$(dirname "$META_FILE")

        mkdir -p packs
        cp -r "$META_DIR/"* packs/

        echo "VM + META installation complete."

    # ------------------------------------------------------------
    # Prepare Dirs
    # ------------------------------------------------------------
    - name: Prepare Dirs
      shell: bash
      run: |
        mkdir -p $BUILD_DIR
        mkdir -p $PROOF_DIR

    # ------------------------------------------------------------
    # Ensure example RLK file
    # ------------------------------------------------------------
    - name: Ensure example RLK exists
      shell: bash
      run: |
        if [ ! -f examples/hello.rlk ]; then
            mkdir -p examples
            echo "let x = 10;" > examples/hello.rlk
            echo "print(x);" >> examples/hello.rlk
        fi

    # ------------------------------------------------------------
    # RLK → SpongeLang
    # ------------------------------------------------------------
    - name: RLK → SpongeLang
      shell: bash
      run: |
        cd "$GITHUB_WORKSPACE"
        $RLK_PATH examples/hello.rlk > $BUILD_DIR/output.sp
        cat $BUILD_DIR/output.sp

    # ------------------------------------------------------------
    # SpongeLang → NASM (cwd fix!)
    # ------------------------------------------------------------
    - name: SpongeLang → NASM ASM
      shell: bash
      run: |
        cd "$GITHUB_WORKSPACE"    # ★★★★★ 핵심 fix (cwd 강제)
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
            ./spongevm.exe --emit-nasm $BUILD_DIR/output.sp -o $BUILD_DIR/output.asm
        else
            ./spongevm --emit-nasm $BUILD_DIR/output.sp -o $BUILD_DIR/output.asm
        fi
        cat $BUILD_DIR/output.asm

    # ------------------------------------------------------------
    # Linux: assemble → link
    # ------------------------------------------------------------
    - name: Install NASM & GCC (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y nasm gcc

    - name: Build Binary (Linux)
      if: runner.os == 'Linux'
      run: |
        nasm -f elf64 $BUILD_DIR/output.asm -o $BUILD_DIR/output.o
        gcc $BUILD_DIR/output.o -o $BUILD_DIR/output.bin

    # ------------------------------------------------------------
    # SHA256 Proof
    # ------------------------------------------------------------
    - name: Generate SHA256 Proof
      shell: bash
      run: |
        cd "$GITHUB_WORKSPACE"
        if command -v sha256sum ; then
            sha256sum $BUILD_DIR/* > $PROOF_DIR/sha256_${{ matrix.os }}.txt
        else
            shasum -a 256 $BUILD_DIR/* > $PROOF_DIR/sha256_${{ matrix.os }}.txt
        fi

    # ------------------------------------------------------------
    # ProofLedger
    # ------------------------------------------------------------
    - name: Generate ProofLedger
      shell: bash
      run: |
        cd "$GITHUB_WORKSPACE"
        echo "OS: ${{ matrix.os }}" > $PROOF_DIR/proofledger_${{ matrix.os }}.txt
        echo "Commit: $GITHUB_SHA" >> $PROOF_DIR/proofledger_${{ matrix.os }}.txt
        echo "Timestamp: $(date)" >> $PROOF_DIR/proofledger_${{ matrix.os }}.txt

    # ------------------------------------------------------------
    # Upload artifacts
    # ------------------------------------------------------------
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: RLK-Pipeline-${{ matrix.os }}
        path: |
          build/
          proof/
          spongevm*
          packs/

# =============================================================
# RELEASE JOB
# =============================================================
  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/download-artifact@v4

    - name: Publish Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v1.${{ github.run_number }}
        name: "RLK Full Auto Pipeline v1.${{ github.run_number }}"
        files: |
          RLK-Pipeline-ubuntu-latest/**
          RLK-Pipeline-macos-latest/**
          RLK-Pipeline-windows-latest/**
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
