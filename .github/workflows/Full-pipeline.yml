name: "SpongeLang — FULL AUTO KotlinNative Build + META + Release"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write


# ===========================================================
# AUTO TAG
# ===========================================================
jobs:
  auto-tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag-step.outputs.tag }}

    steps:
      - uses: actions/checkout@v4

      - name: Generate timestamp tag
        id: tag-step
        run: |
          TAG="v$(date +'%Y%m%d%H%M%S')"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Push tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag ${{ steps.tag-step.outputs.tag }}
          git push origin ${{ steps.tag-step.outputs.tag }}


# ===========================================================
# BUILD (Linux / Mac / Windows)
# ===========================================================
  build:
    needs: auto-tag
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-13, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      # Python for SpongeLang
      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install pyyaml

      # Kotlin Native 설치
      - name: Install Kotlin Native
        shell: bash
        run: |
          curl -L https://github.com/JetBrains/kotlin/releases/download/v2.0.20/kotlin-native-prebuilt-${{ matrix.os }}.zip -o kotlin_native.zip
          unzip kotlin_native.zip -d kotlin_native
          echo "$PWD/kotlin_native/bin" >> $GITHUB_PATH

      # =====================================================
      # SpongeLang → Kotlin 코드 생성
      # =====================================================
      - name: Run SpongeLang (Generate .kt)
        run: |
          mkdir -p generated
          python3 tools/spongelang.py input.sp --out generated/Main.kt

      # =====================================================
      # Kotlin Native 컴파일
      # =====================================================
      - name: Build Kotlin Native
        shell: bash
        run: |
          mkdir -p build/bin
          kotlinc-native generated/Main.kt -o build/bin/spongelang_native

      # =====================================================
      # META Pack 생성
      # =====================================================
      - name: Generate META Pack
        shell: bash
        run: |
          python3 tools/generate_meta.py
          mkdir -p build/bin/packs
          cp -r packs/* build/bin/packs/

      # =====================================================
      # Debug output
      # =====================================================
      - name: Debug Output
        shell: bash
        run: |
          echo "==== build/bin ===="
          ls -al build/bin || true
          echo "==== packs ===="
          ls -al build/bin/packs || true

      # =====================================================
      # Upload artifact
      # =====================================================
      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: spongelang-${{ matrix.os }}
          path: build/bin/*
          if-no-files-found: error


# ===========================================================
# RELEASE
# ===========================================================
  auto-release:
    needs: [auto-tag, build]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: release-temp

      - name: Organize Release Files
        run: |
          mkdir -p release/linux release/macos release/windows

          cp -r release-temp/spongelang-ubuntu-latest/* release/linux/ || true
          cp -r release-temp/spongelang-macos-13/* release/macos/ || true
          cp -r release-temp/spongelang-windows-latest/* release/windows/ || true

      - name: Create Release ZIPs
        run: |
          cd release
          zip -r linux.zip linux
          zip -r macos.zip macos
          zip -r windows.zip windows

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.auto-tag.outputs.tag }}
          name: "SpongeLang — FULL AUTO KotlinNative + META — ${{ needs.auto-tag.outputs.tag }}"
          body: |
            ## SpongeLang Full Auto Kotlin Native Release
            - 3OS Native executables
            - Auto-generated .kt from SpongeLang
            - Full META pack included
            - Timestamp Auto Tag
          files: release/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
