name: "SpongeLang — FULL AUTO 3OS + UNIVERSAL BINARY + META + RELEASE"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ==============================================================
  # AUTO TAG
  # ==============================================================
  auto-tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.tag }}

    steps:
      - uses: actions/checkout@v4

      - name: Generate timestamp tag
        id: tag
        run: |
          TAG="v$(date +'%Y%m%d%H%M%S')"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Push tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag ${{ steps.tag.outputs.tag }}
          git push origin ${{ steps.tag.outputs.tag }}

  # ==============================================================
  # 3OS BUILD (Linux / Windows / macOS Universal Binary)
  # ==============================================================
  build:
    needs: auto-tag
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      # Build SpongeLang compiler
      - name: Build rlkc (compiler)
        run: cargo build --release

      - name: Prepare build directory
        run: mkdir -p build

      # ============================================================
      # LINUX
      # ============================================================
      - name: Build on Linux
        if: matrix.os == 'ubuntu-latest'
        run: |
          ./target/release/rlkc > build/out.asm
          nasm -felf64 build/out.asm -o build/out.o
          ld build/out.o -o build/spongelang \
            --dynamic-linker /lib64/ld-linux-x86-64.so.2 \
            -lc

      # ============================================================
      # WINDOWS
      # ============================================================
      - name: Build on Windows
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          ./target/release/rlkc | Out-File build/out.asm -Encoding ascii
          nasm -f win64 build/out.asm -o build/out.obj
          link.exe build/out.obj /ENTRY:main /SUBSYSTEM:CONSOLE /OUT:build\spongelang.exe

      # ============================================================
      # macOS — Universal Binary
      # ============================================================
      - name: Install NASM (macOS)
        if: matrix.os == 'macos-latest'
        run: brew install nasm

      - name: Build on macOS
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          SDK=$(xcrun --show-sdk-path)

          ./target/release/rlkc > build/out_x86.asm
          cp build/out_x86.asm build/out_arm.asm

          # x86_64
          nasm -fmacho64 build/out_x86.asm -o build/out_x86.o
          ld -arch x86_64 \
            -platform_version macos 12.0 12.0 \
            -syslibroot "$SDK" -lSystem \
            build/out_x86.o -o build/spongelang_x86

          # arm64
          nasm -fmacho64 build/out_arm.asm -o build/out_arm.o
          ld -arch arm64 \
            -platform_version macos 12.0 12.0 \
            -syslibroot "$SDK" -lSystem \
            build/out_arm.o -o build/spongelang_arm

          # Merge universal binary
          lipo -create -output build/spongelang build/spongelang_x86 build/spongelang_arm

          # Hardened runtime codesign
          codesign --force --deep --options runtime --sign "-" build/spongelang

          # OPTIONAL: notarization
          if [[ -n "$APPLE_ID" && -n "$TEAM_ID" && -n "$APP_PASSWORD" ]]; then
            xcrun notarytool submit build/spongelang \
              --apple-id "$APPLE_ID" \
              --team-id "$TEAM_ID" \
              --password "$APP_PASSWORD" \
              --wait
          else
            echo "Notarization skipped."
          fi

      # ============================================================
      # ZIP PACKAGE
      # ============================================================
      - name: Zip build output
        shell: bash
        run: |
          cd build
          zip -r ../${{ matrix.os }}.zip .

      - uses: actions/upload-artifact@v4
        with:
          name: spongelang-${{ matrix.os }}
          path: ${{ matrix.os }}.zip

  # ==============================================================
  # RELEASE
  # ==============================================================
  release:
    needs: [auto-tag, build]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: release-files

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.auto-tag.outputs.tag }}
          name: "SpongeLang FULL AUTO Release — ${{ needs.auto-tag.outputs.tag }}"
          body: |
            ## SpongeLang FULL AUTO Release  
            - Linux ELF64 binary  
            - Windows x64 EXE  
            - macOS Universal Binary (x86_64 + arm64)  
            - Hardened Runtime (macOS)  
            - Auto META Pack  
            - Auto Tag + Release  
          files: release-files/**/*.zip
